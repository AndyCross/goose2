@using goose2s.Services
@using goose2s.State
@using goose2s.Models
@inject SearchService search
@inject QueueService queue


@code {
    [CascadingParameter]
    private SpotifyStateProvider SpotifyStateProvider { get; set; }
    private SearchResults results { get; set; }
    private async Task SearchChanged(ChangeEventArgs e)
    {
        results = await search.SearchTrack(e.Value.ToString(), SpotifyStateProvider.CurrentContext.access_token);
    }
    private async Task Add(MouseEventArgs e, SpotifyItem item) {
        await queue.Enqueue("static", item);
    }
}


@if (SpotifyStateProvider.CurrentContext == null || !SpotifyStateProvider.CurrentContext.Success)
{
    <p><em>Not logged in</em></p>
}
else if (results == null) 
{
<div>
    <input type="text" @onchange="SearchChanged" />
</div>
    <p><em>No results</em></p>
}
else
{
<div>
    <input type="text" @onchange="SearchChanged" />
</div>
<div>
    <table class="core">
        <thead>
            <tr>
                <th>...</th>
                <th>Image</th>
                <th>Name</th>
                <th>Artist</th>
                <th>Popularity</th>
            </tr>
        </thead>
        <tbody>            
    @foreach (var result in results.tracks.items)
    {
            <tr>
                <td><button @onclick="@(e => Add(e, result))">+</button></td>
                <td><img src="@result.album?.images.OrderBy(i=>i.width).First().url" /></td>
                <td>@result.name</td>
                <td>@result.artists[0].name</td>  
                <td>
                    <table width="100%" class="slim">
                        <tr>
                            <td width="@(result.popularity)%" style="background-color:#6f42c1"></td>
                            <td width="@(100-result.popularity)%" style="background-color:#eee"></td>
                        </tr>
                    </table></td>      
            </tr>
    }
        </tbody>
    </table>
</div>
}