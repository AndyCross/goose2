@using goose2s.Services
@using goose2s.State
@using goose2s.Models
@using System.Threading
@inject QueueService queue


@code {
    [CascadingParameter]
    private SpotifyStateProvider SpotifyStateProvider { get; set; }
    private long sequenceNumber { get; set; }
    private QueueItem[] results { get; set; }
    [Parameter]
    public Action<QueueItem> TrackChanged { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var resultT = await queue.GetQueue("static", -1L);
        sequenceNumber = resultT.Item1;
        results = resultT.Item2;

        var timer = new Timer(new TimerCallback(async _ =>
        {
            await InvokeAsync(async () => {
                var resultsT = await queue.GetQueue("static", sequenceNumber);
                if (resultsT.Item1 != long.MinValue) {
                    results = resultsT.Item2;
                    sequenceNumber = resultsT.Item1;
                    this.StateHasChanged();
                }
            });
        }), null, 168, 168);
    }
    private void Yield(MouseEventArgs eventArgs, QueueItem item) {
        TrackChanged?.Invoke(item);
    }
}

<div>
</div>

@if (results == null)
{
    <p><em>Loading...</em></p>
}
else
{
<div>
    <table class="core">
        <thead>
            <tr>
                <th>...</th>
                <th>Image</th>
                <th>Name</th>
                <th>Artist</th>
                <th>Popularity</th>
            </tr>
        </thead>
        <tbody>            
    @foreach (var result in results)
    {
            <tr>
                <td><button @onclick="@((e)=>Yield(e, result))">▶️</button></td>
                <td><img src="@result.Image" /></td>
                <td>@result.TrackName</td>
                <td>@result.ArtistName</td>  
                <td>
                    <table width="100%" class="slim">
                        <tr>
                            <td width="@(result.Popularity)%" style="background-color:#6f42c1"></td>
                            <td width="@(100-result.Popularity)%" style="background-color:#eee"></td>
                        </tr>
                    </table></td>      
            </tr>
    }
        </tbody>
    </table>
</div>
}